
-- Tạo cơ sở dữ liệu THCSDL2_NHOM1
CREATE DATABASE TCSDL2_NHOM1;
GO

-- Sử dụng cơ sở dữ liệu vừa tạo
USE TCSDL2_NHOM1;
GO

-- Tạo bảng KHACHHANG
CREATE TABLE KHACHHANG (
    MAKHACHHANG CHAR(8) PRIMARY KEY,
    TENCONGTY NVARCHAR(100) NOT NULL,
    TENGIAODICH NVARCHAR(100) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    EMAIL VARCHAR(50) NOT NULL UNIQUE,
    DIENTHOAI VARCHAR(11) NOT NULL,
    FAX VARCHAR(10) NULL,
    CONSTRAINT CK_SDT_KH CHECK(DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' 
                            OR DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
);

-- Tạo bảng NHANVIEN
CREATE TABLE NHANVIEN (
    MANHANVIEN CHAR(8) PRIMARY KEY,
    HO NVARCHAR(10) NOT NULL,
    TEN NVARCHAR(40) NOT NULL,
    NGAYSINH DATE,
    NGAYLAMVIEC DATE,
    DIACHI NVARCHAR(100) NOT NULL,
    DIENTHOAI VARCHAR(11) NOT NULL UNIQUE,
    LUONGCOBAN DECIMAL(20, 2) CHECK (LUONGCOBAN >= 0),
    PHUCAP DECIMAL(20, 2) CHECK (PHUCAP >= 0),
    CONSTRAINT CK_SDT_NV CHECK(DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' 
                            OR DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'),
    );

-- Tạo bảng DONDATHANG
CREATE TABLE DONDATHANG (
    SOHOADON CHAR(8) PRIMARY KEY,
    MAKHACHHANG CHAR(8) NOT NULL,
    MANHANVIEN CHAR(8) NOT NULL,
    NGAYDATHANG DATE,
    NGAYGIAOHANG DATE,
    NGAYCHUYENHANG DATE,
    NOIGIAOHANG NVARCHAR(100),
    CONSTRAINT FK_MAKHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG)
                                ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_MANHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
                                ON UPDATE CASCADE ON DELETE CASCADE
    );

-- Tạo bảng NHACUNGCAP
CREATE TABLE NHACUNGCAP (
    MACONGTY CHAR(8) PRIMARY KEY,
    TENCONGTY NVARCHAR(100) NOT NULL,
    TENGIAODICH VARCHAR(50) NOT NULL,
    DIACHI NVARCHAR(100),
    DIENTHOAI VARCHAR(11) NOT NULL UNIQUE,
    FAX VARCHAR(10),
    EMAIL VARCHAR(50) UNIQUE
);
GO

-- Tạo bảng LOAIHANG
CREATE TABLE LOAIHANG (
    MALOAIHANG CHAR(8) PRIMARY KEY,
    TENLOAIHANG NVARCHAR(100) NOT NULL
);

-- Tạo bảng MATHANG
CREATE TABLE MATHANG (
    MAHANG CHAR(8) PRIMARY KEY,
    TENHANG NVARCHAR(100) NOT NULL,
    MACONGTY CHAR(8) NOT NULL,
    MALOAIHANG CHAR(8) NOT NULL,
    SOLUONG FLOAT CHECK(SOLUONG >= 0),
    DONVITINH NVARCHAR(100),
    GIAHANG DECIMAL(20, 2) CHECK(GIAHANG >= 0),
    CONSTRAINT FK_MACONGTY FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP(MACONGTY)
                              ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_MALOAIHANG FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG(MALOAIHANG)
                                ON UPDATE CASCADE ON DELETE CASCADE
);

-- Tạo bảng CHITIETDATHANG
CREATE TABLE CHITIETDATHANG (
    SOHOADON CHAR(8) NOT NULL,
    MAHANG CHAR(8) NOT NULL,
    GIABAN DECIMAL(20, 2),
    SOLUONG FLOAT ,
    MUCGIAMGIA DECIMAL(5,2),
    CONSTRAINT PK_SHD_MH PRIMARY KEY (SOHOADON, MAHANG),
    CONSTRAINT FK_SOHOADON FOREIGN KEY (SOHOADON) REFERENCES DONDATHANG(SOHOADON)
                             ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_MAHANG FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG)
                           ON UPDATE CASCADE ON DELETE CASCADE
);
-- Câu2

-- Thiết lập giá trị mặc định bằng 1 cho cột SOLUONG
ALTER TABLE CHITIETDATHANG
	ADD CONSTRAINT DF_SOLUONG DEFAULT 1 FOR SOLUONG;

-- Thiết lập giá trị mặc định bằng 0 cho cột MUCGIAMGIA
ALTER TABLE CHITIETDATHANG
	ADD CONSTRAINT DF_MUCGIAMGIA DEFAULT 0 FOR MUCGIAMGIA;

-- Câu3

--Bổ sung cho bảng DONDATHANG ràng buộc kiểm tra ngày giao hàng và ngày chuyển hàng phải sau hoặc bằng với ngày đặt hàng. 
ALTER TABLE DONDATHANG
	ADD CONSTRAINT CK_NGAY CHECK (NGAYGIAOHANG >= NGAYDATHANG AND NGAYCHUYENHANG >= NGAYGIAOHANG);

-- Câu4

--Bổ sung ràng buộc cho bảng NHANVIEN để đảm bảo rằng một nhân viên chỉ có thể làm việc trong công ty khi đủ 18 tuổi 
	--và không quá 60 tuổi.
ALTER TABLE NHANVIEN
	ADD CONSTRAINT CK_TUOI 
	CHECK (DATEDIFF(YEAR, NGAYSINH, NGAYLAMVIEC) >= 18 AND DATEDIFF(YEAR, NGAYSINH, NGAYLAMVIEC) <= 60);

-- Thêm dữ liệu vào bảng KHACHHANG
INSERT INTO KHACHHANG (MAKHACHHANG, TENCONGTY, TENGIAODICH, DIACHI, EMAIL, DIENTHOAI, FAX) VALUES
('KH00001', 'Cong ty X', 'Nguyen Van X', '12 Hoan Kiem, HN', 'contactX@company.com', '0911000001', '0438200001'),
('KH00002', 'Cong ty Y', 'Tran Thi Y', '34 Hai Ba Trung, HN', 'contactY@company.com', '0911000002', '0438200002'),
('KH00003', 'Cong ty Z', 'Le Van Z', '56 Ba Dinh, HN', 'contactZ@company.com', '0911000003', '0438200003'),
('KH00004', 'Cong ty K', 'Pham Thi K', '78 Cau Giay, HN', 'contactK@company.com', '0911000004', '0438200004'),
('KH00005', 'Cong ty L', 'Hoang Van L', '90 Dong Da, HN', 'contactL@company.com', '0911000005', '0438200005'),
('KH00006', 'Cong ty M', 'Ngo Thi M', '23 Long Bien, HN', 'contactM@company.com', '0911000006', '0438200006'),
('KH00007', 'Cong ty N', 'Doan Van N', '45 Ha Dong, HN', 'contactN@company.com', '0911000007', '0438200007');

-- Thêm dữ liệu vào bảng NHANVIEN
INSERT INTO NHANVIEN (MANHANVIEN, HO, TEN, NGAYSINH, NGAYLAMVIEC, DIACHI, DIENTHOAI, LUONGCOBAN, PHUCAP) VALUES
('NV00001', 'Nguyen', 'Anh', '1985-01-01', '2010-01-01', '12 Tran Phu, HN', '0912000001', 10000000, 2000000),
('NV00002', 'Tran', 'Binh', '1990-05-05', '2012-06-01', '34 Dinh Tien Hoang, HN', '0912000002', 12000000, 2500000),
('NV00003', 'Le', 'Cuong', '1988-02-18', '2011-03-15', '56 Hang Bong, HN', '0912000003', 13000000, 1500000),
('NV00004', 'Hoang', 'Dai', '1982-08-09', '2008-05-21', '78 Dien Bien Phu, HN', '0912000004', 11000000, 1800000),
('NV00005', 'Pham', 'E', '1995-12-30', '2016-09-05', '90 Tran Quoc Toan, HN', '0912000005', 9000000, 1000000),
('NV00006', 'Ngo', 'F', '1991-07-22', '2013-12-15', '23 Hoang Hoa Tham, HN', '0912000006', 10500000, 1200000),
('NV00007', 'Doan', 'G', '1987-11-13', '2012-03-10', '45 Ba Trieu, HN', '0912000007', 9500000, 1100000);

-- Thêm dữ liệu vào bảng NHACUNGCAP
INSERT INTO NHACUNGCAP (MACONGTY, TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, FAX, EMAIL) VALUES
('NCC0001', 'NCC X', 'Dai Ly X', '12 Tran Hung Dao, HN', '0913000001', '0438210001', 'nccX@company.com'),
('NCC0002', 'NCC Y', 'Dai Ly Y', '34 Pham Ngu Lao, HN', '0913000002', '0438210002', 'nccY@company.com'),
('NCC0003', 'NCC Z', 'Dai Ly Z', '56 Bach Dang, HN', '0913000003', '0438210003', 'nccZ@company.com'),
('NCC0004', 'NCC K', 'Dai Ly K', '78 Tran Quang Khai, HN', '0913000004', '0438210004', 'nccK@company.com'),
('NCC0005', 'NCC L', 'Dai Ly L', '90 Van Cao, HN', '0913000005', '0438210005', 'nccL@company.com'),
('NCC0006', 'NCC M', 'Dai Ly M', '23 Thuy Khue, HN', '0913000006', '0438210006', 'nccM@company.com'),
('NCC0007', 'NCC N', 'Dai Ly N', '45 Le Duan, HN', '0913000007', '0438210007', 'nccN@company.com');

-- Thêm dữ liệu vào bảng LOAIHANG
INSERT INTO LOAIHANG (MALOAIHANG, TENLOAIHANG) VALUES
('LH00001', 'Thiet Bi Dien'),
('LH00002', 'Do Gia Dung'),
('LH00003', 'Noi That'),
('LH00004', 'Thoi Trang'),
('LH00005', 'My Pham'),
('LH00006', 'Van Phong Pham'),
('LH00007', 'Dien Thoai Di Dong');

-- Thêm dữ liệu vào bảng MATHANG
INSERT INTO MATHANG (MAHANG, TENHANG, MACONGTY, MALOAIHANG, SOLUONG, DONVITINH, GIAHANG) VALUES
('MH00001', 'Ban Ui', 'NCC0001', 'LH00001', 100, 'Cai', 300000),
('MH00002', 'Noi Com Dien', 'NCC0002', 'LH00002', 150, 'Cai', 500000),
('MH00003', 'Ghe Sofa', 'NCC0003', 'LH00003', 20, 'Bo', 8000000),
('MH00004', 'Ao Thun', 'NCC0004', 'LH00004', 300, 'Cai', 150000),
('MH00005', 'Kem Duong Da', 'NCC0005', 'LH00005', 80, 'Chai', 200000),
('MH00006', 'But Bi', 'NCC0006', 'LH00006', 500, 'Cai', 5000),
('MH00007', 'Dien Thoai', 'NCC0007', 'LH00007', 50, 'Cai', 10000000);

-- Thêm dữ liệu vào bảng DONDATHANG
INSERT INTO DONDATHANG (SOHOADON, MAKHACHHANG, MANHANVIEN, NGAYDATHANG, NGAYGIAOHANG, NGAYCHUYENHANG, NOIGIAOHANG) VALUES
('HD00001', 'KH00001', 'NV00001', '2024-10-01', '2024-10-05', '2024-10-07', '123 Ly Thuong Kiet, HN'),
('HD00002', 'KH00002', 'NV00002', '2024-10-02', '2024-10-06', NULL, '456 Hoang Hoa Tham, HN'),
('HD00003', 'KH00003', 'NV00003', '2024-10-03', '2024-10-07', '2024-10-09', '789 Nguyen Chi Thanh, HN'),
('HD00004', 'KH00004', 'NV00004', '2024-10-04', '2024-10-08', '2024-10-10', '101 Tran Hung Dao, HN'),
('HD00005', 'KH00005', 'NV00005', '2024-10-05', '2024-10-09', '2024-10-11', '202 Dinh Cong, HN'),
('HD00006', 'KH00006', 'NV00006', '2024-10-06', '2024-10-10', '2024-10-12', '303 Tran Duy Hung, HN'),
('HD00007', 'KH00007', 'NV00007', '2024-10-07', '2024-10-11', NULL, '404 Thanh Nien, HN');

-- Thêm dữ liệu vào bảng CHITIETDATHANG
INSERT INTO CHITIETDATHANG (SOHOADON, MAHANG, GIABAN, SOLUONG, MUCGIAMGIA) VALUES
('HD00001', 'MH00001', 300000, 2, 0),
('HD00002', 'MH00002', 500000, 1, 0.05),
('HD00003', 'MH00003', 8000000, 1, 0.10),
('HD00004', 'MH00004', 150000, 3, 0),
('HD00005', 'MH00005', 200000, 2, 0.05),
('HD00006', 'MH00006', 5000, 10, 0),
('HD00007', 'MH00007', 10000000, 1, 0.15);

--Tuần 8
--a) Cập nhật lại giá trị trường NGAYCHUYENHANG của những bản ghi có 
--NGAYCHUYENHANG chưa xác định (NULL) trong bảng DONDATHANG 
--bằng với giá trị của trường NGAYDATHANG.
UPDATE DONDATHANG
SET NGAYCHUYENHANG = NGAYDATHANG
WHERE NGAYCHUYENHANG IS NULL;

--b)Tăng số lượng hàng của những mặt hàng do công ty VINAMILK cung cấp lên gấp đôi
UPDATE MATHANG 
SET SOLUONG = SOLUONG * 2
WHERE MACONGTY IN (SELECT MACONGTY FROM NHACUNGCAP WHERE TENCONGTY = 'VINAMILK');


--c)Cập nhật giá trị của trường NOIGIAOHANG trong bảng DONDATHANG bằng địa chỉ của khách hàng đối với những đơn đặt hàng 
--chưa xác định được nơi giao hàng (giá trị trường NOIGIAOHANG bằng NULL).
UPDATE DONDATHANG
SET NOIGIAOHANG =( SELECT DIACHI FROM KHACHHANG WHERE KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG )
WHERE NOIGIAOHANG IS NULL;

--d) Cập nhật lại dữ liệu trong bảng KHACHHANG sao cho nếu tên công ty 
--và tên giao dịch của khách hàng trùng với tên công ty 
--và tên giao dịch của một nhà cung cấp nào đó thì địa chỉ, điện thoại, fax và e-mail phải giống nhau.
UPDATE DONDATHANG
SET SOHOADON = KHACHHANG.DIACHI
FROM DONDATHANG
JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
WHERE DONDATHANG.NOIGIAOHANG IS NULL;

--e)Tăng lương lên gấp rưỡi cho những nhân viên bán được số lượng hàng nhiều hơn 100 trong năm 2022.
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN * 1.5
WHERE MANHANVIEN IN (
    SELECT DONDATHANG.MANHANVIEN
    FROM DONDATHANG
    JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    WHERE YEAR(DONDATHANG.NGAYDATHANG) = 2022
    GROUP BY DONDATHANG.MANHANVIEN
    HAVING SUM(CHITIETDATHANG.SOLUONG) > 100
);

--f) Tăng phụ cấp lên bằng 50% lương cho những nhân viên bán được hàng nhiều nhất.
UPDATE NHANVIEN
SET PHUCAP = LUONGCOBAN * 0.5
WHERE MANHANVIEN IN (
    SELECT TOP 1 DONDATHANG.MANHANVIEN
    FROM DONDATHANG
    JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    GROUP BY DONDATHANG.MANHANVIEN
    ORDER BY SUM(CHITIETDATHANG.SOLUONG) DESC
);


--g)Giảm 25% lương của những nhân viên trong năm 2023 không lập được bất kỳ đơn đặt hàng nào.
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN * 0.75
WHERE MANHANVIEN NOT IN (
    SELECT DISTINCT MANHANVIEN
    FROM DONDATHANG
    WHERE YEAR(NGAYDATHANG) = 2023)




